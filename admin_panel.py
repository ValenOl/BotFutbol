import logging
from datetime import datetime, timedelta
from typing import Dict, List
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from config import ADMIN_CONFIG, MENSAJES
from database import db
import asyncio

class AdminPanel:
    def __init__(self):
        self.admin_ids = ADMIN_CONFIG['admin_ids']
        self.log_channel = ADMIN_CONFIG['log_channel']
        self.support_channel = ADMIN_CONFIG['support_channel']
    
    def is_admin(self, chat_id: int) -> bool:
        """Verifica si un usuario es administrador"""
        return chat_id in self.admin_ids
    
    async def admin_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Men√∫ principal de administraci√≥n"""
        if not self.is_admin(update.effective_chat.id):
            await update.message.reply_text("‚ùå No tienes permisos de administrador.")
            return
        
        keyboard = [
            [InlineKeyboardButton('üìä Estad√≠sticas', callback_data='admin_stats')],
            [InlineKeyboardButton('üë• Gesti√≥n de Usuarios', callback_data='admin_users')],
            [InlineKeyboardButton('üì¢ Mensaje Masivo', callback_data='admin_broadcast')],
            [InlineKeyboardButton('üíé Gesti√≥n Premium', callback_data='admin_premium')],
            [InlineKeyboardButton('üîß Configuraci√≥n', callback_data='admin_config')],
            [InlineKeyboardButton('üìã Logs', callback_data='admin_logs')]
        ]
        
        mensaje = (
            "üîß *Panel de Administraci√≥n*\n\n"
            "Bienvenido al panel de control del bot.\n"
            "Selecciona una opci√≥n para continuar.\n\n"
            "Desarrollado por Valent√≠n Olivero"
        )
        
        await update.message.reply_text(
            mensaje,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    async def admin_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Maneja los callbacks del panel de administraci√≥n"""
        query = update.callback_query
        await query.answer()
        
        if not self.is_admin(query.message.chat_id):
            await query.edit_message_text("‚ùå No tienes permisos de administrador.")
            return
        
        data = query.data
        
        if data == 'admin_stats':
            await self.show_stats(query)
        elif data == 'admin_users':
            await self.show_users_menu(query)
        elif data == 'admin_broadcast':
            await self.show_broadcast_menu(query)
        elif data == 'admin_premium':
            await self.show_premium_menu(query)
        elif data == 'admin_config':
            await self.show_config_menu(query)
        elif data == 'admin_logs':
            await self.show_logs(query)
        elif data.startswith('admin_user_'):
            await self.show_user_details(query, data)
        elif data.startswith('admin_broadcast_'):
            await self.handle_broadcast(query, data)
    
    async def show_stats(self, query):
        """Muestra estad√≠sticas del bot"""
        stats = db.get_stats()
        
        mensaje = (
            "üìä *Estad√≠sticas del Bot*\n\n"
            f"üë• **Total de usuarios:** {stats.get('total_users', 0)}\n"
            f"üíé **Usuarios Premium:** {stats.get('premium_users', 0)}\n"
            f"üìà **% Premium:** {stats.get('premium_percentage', 0):.1f}%\n"
            f"üîç **Consultas hoy:** {stats.get('queries_today', 0)}\n"
            f"‚ö° **Usuarios activos hoy:** {stats.get('active_today', 0)}\n\n"
            f"üìÖ *Fecha:* {datetime.now().strftime('%d/%m/%Y %H:%M')}"
        )
        
        keyboard = [[InlineKeyboardButton('üîô Volver', callback_data='admin_back')]]
        
        await query.edit_message_text(
            mensaje,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    async def show_users_menu(self, query):
        """Men√∫ de gesti√≥n de usuarios"""
        users = db.get_all_users()
        
        mensaje = (
            "üë• *Gesti√≥n de Usuarios*\n\n"
            f"Total de usuarios: {len(users)}\n\n"
            "Selecciona una opci√≥n:"
        )
        
        keyboard = [
            [InlineKeyboardButton('üìã Listar Usuarios', callback_data='admin_list_users')],
            [InlineKeyboardButton('üîç Buscar Usuario', callback_data='admin_search_user')],
            [InlineKeyboardButton('üìä Usuarios Premium', callback_data='admin_premium_users')],
            [InlineKeyboardButton('üìä Usuarios Gratuitos', callback_data='admin_free_users')],
            [InlineKeyboardButton('üîô Volver', callback_data='admin_back')]
        ]
        
        await query.edit_message_text(
            mensaje,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    async def show_broadcast_menu(self, query):
        """Men√∫ de mensajes masivos"""
        mensaje = (
            "üì¢ *Mensaje Masivo*\n\n"
            "Env√≠a un mensaje a todos los usuarios del bot.\n\n"
            "Selecciona el tipo de mensaje:"
        )
        
        keyboard = [
            [InlineKeyboardButton('üì¢ A Todos', callback_data='admin_broadcast_all')],
            [InlineKeyboardButton('üíé Solo Premium', callback_data='admin_broadcast_premium')],
            [InlineKeyboardButton('üîπ Solo Gratuitos', callback_data='admin_broadcast_free')],
            [InlineKeyboardButton('üîô Volver', callback_data='admin_back')]
        ]
        
        await query.edit_message_text(
            mensaje,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    async def show_premium_menu(self, query):
        """Men√∫ de gesti√≥n premium"""
        stats = db.get_stats()
        premium_users = stats.get('premium_users', 0)
        total_users = stats.get('total_users', 0)
        
        mensaje = (
            "üíé *Gesti√≥n Premium*\n\n"
            f"Usuarios Premium: {premium_users}/{total_users}\n"
            f"Porcentaje: {stats.get('premium_percentage', 0):.1f}%\n\n"
            "Selecciona una acci√≥n:"
        )
        
        keyboard = [
            [InlineKeyboardButton('‚ûï Dar Premium', callback_data='admin_give_premium')],
            [InlineKeyboardButton('‚ûñ Quitar Premium', callback_data='admin_remove_premium')],
            [InlineKeyboardButton('üìä Estad√≠sticas Premium', callback_data='admin_premium_stats')],
            [InlineKeyboardButton('üîô Volver', callback_data='admin_back')]
        ]
        
        await query.edit_message_text(
            mensaje,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    async def show_config_menu(self, query):
        """Men√∫ de configuraci√≥n"""
        mensaje = (
            "üîß *Configuraci√≥n del Bot*\n\n"
            "Configuraci√≥n actual:\n"
            "‚Ä¢ L√≠mite gratuito: 10 consultas/d√≠a\n"
            "‚Ä¢ Monitoreo: 60 segundos\n"
            "‚Ä¢ Ligas disponibles: 10\n\n"
            "Selecciona una opci√≥n:"
        )
        
        keyboard = [
            [InlineKeyboardButton('‚öôÔ∏è Cambiar L√≠mites', callback_data='admin_change_limits')],
            [InlineKeyboardButton('üïê Cambiar Monitoreo', callback_data='admin_change_monitoring')],
            [InlineKeyboardButton('üèÜ Gestionar Ligas', callback_data='admin_manage_leagues')],
            [InlineKeyboardButton('üîô Volver', callback_data='admin_back')]
        ]
        
        await query.edit_message_text(
            mensaje,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    async def show_logs(self, query):
        """Muestra logs del sistema"""
        mensaje = (
            "üìã *Logs del Sistema*\n\n"
            "Funcionalidad en desarrollo.\n\n"
            "Los logs se guardan autom√°ticamente en:\n"
            "‚Ä¢ Errores de API\n"
            "‚Ä¢ Actividad de usuarios\n"
            "‚Ä¢ Cambios de suscripci√≥n\n"
            "‚Ä¢ Mensajes masivos"
        )
        
        keyboard = [[InlineKeyboardButton('üîô Volver', callback_data='admin_back')]]
        
        await query.edit_message_text(
            mensaje,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    async def handle_broadcast(self, query, data):
        """Maneja el env√≠o de mensajes masivos"""
        broadcast_type = data.split('_')[2]
        
        # Guardar el tipo de broadcast en el contexto
        query.message.chat_data['broadcast_type'] = broadcast_type
        
        mensaje = (
            "üì¢ *Mensaje Masivo*\n\n"
            f"Tipo: {broadcast_type.upper()}\n\n"
            "Escribe el mensaje que quieres enviar:\n"
            "Usa /cancel para cancelar"
        )
        
        keyboard = [[InlineKeyboardButton('‚ùå Cancelar', callback_data='admin_back')]]
        
        await query.edit_message_text(
            mensaje,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
    
    async def send_broadcast(self, message_text: str, broadcast_type: str, context: ContextTypes.DEFAULT_TYPE) -> Dict:
        """Env√≠a un mensaje masivo"""
        users = db.get_all_users()
        sent_count = 0
        failed_count = 0
        
        for user in users:
            try:
                # Filtrar usuarios seg√∫n el tipo de broadcast
                if broadcast_type == 'premium' and not db.is_premium(user['chat_id']):
                    continue
                elif broadcast_type == 'free' and db.is_premium(user['chat_id']):
                    continue
                
                await context.bot.send_message(
                    chat_id=user['chat_id'],
                    text=message_text
                )
                sent_count += 1
                
                # Peque√±a pausa para evitar l√≠mites de rate
                await asyncio.sleep(0.1)
                
            except Exception as e:
                logging.error(f"Error sending broadcast to {user['chat_id']}: {e}")
                failed_count += 1
        
        return {
            'sent': sent_count,
            'failed': failed_count,
            'total': len(users)
        }
    
    async def log_admin_action(self, admin_id: int, action: str, details: str = "", context: ContextTypes.DEFAULT_TYPE = None):
        """Registra acciones de administraci√≥n"""
        log_message = (
            f"üîß **Acci√≥n de Administraci√≥n**\n\n"
            f"üë§ Admin ID: `{admin_id}`\n"
            f"üîß Acci√≥n: {action}\n"
            f"üìù Detalles: {details}\n"
            f"üïê Fecha: {datetime.now().strftime('%d/%m/%Y %H:%M')}"
        )
        
        if self.log_channel and context:
            try:
                await context.bot.send_message(
                    chat_id=self.log_channel,
                    text=log_message,
                    parse_mode='Markdown'
                )
            except Exception as e:
                logging.error(f"Error sending admin log: {e}")
    
    def get_user_usage_stats(self, chat_id: int) -> Dict:
        """Obtiene estad√≠sticas de uso de un usuario espec√≠fico"""
        try:
            today = datetime.now().date()
            daily_queries = db.get_daily_queries_count(chat_id, today)
            user = db.get_user(chat_id)
            
            return {
                'chat_id': chat_id,
                'username': user.get('username', 'N/A'),
                'first_name': user.get('first_name', 'N/A'),
                'plan': user.get('plan', 'gratuito'),
                'daily_queries': daily_queries,
                'is_premium': db.is_premium(chat_id),
                'created_at': user.get('created_at', 'N/A'),
                'last_activity': user.get('last_activity', 'N/A')
            }
        except Exception as e:
            logging.error(f"Error getting user usage stats: {e}")
            return {}

# Instancia global del panel de administraci√≥n
admin_panel = AdminPanel() 